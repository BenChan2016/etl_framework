SELECT M.GLOSSTRADEREFERENCE, M.TRADETYPE, 
(CASE 
WHEN M.TRADETYPE IN ('PRIN','NET','CAGS','CSEC','BAGS') THEN 'CSSC'
WHEN M.TRADETYPE IN ('CCSH', 'FXMV','SNET') THEN 'C'
WHEN M.TRADETYPE IN ('NTRN') THEN 'CC'
WHEN M.TRADETYPE IN ('BLPM','DACS','CLBO','CLBR','DTRN','PNET','BLCM','BLOM','FRES','TKOS') THEN 'S'
 END) AS EXPECTED_COMPONENTS,
 DEL.TRADETYPE AS DEL_TRADETYPE, DEL.OPENQUANTITY AS DEL_OPENQUANTITY, REC.TRADETYPE AS REC_TRADETYPE, REC.OPENQUANTITY AS REC_OPENQUANTITY,
(CASE 
 WHEN ((DEL.TRADETYPE = 'CASH' AND REC.TRADETYPE = 'STCK') OR (DEL.TRADETYPE = 'STCK' AND REC.TRADETYPE = 'CASH') AND DEL.OPENQUANTITY = 0 AND REC.OPENQUANTITY = 0) THEN 'CSSC'
 WHEN ((DEL.TRADETYPE = 'CASH' AND REC.TRADETYPE = 'CASH') AND DEL.OPENQUANTITY = 0 AND REC.OPENQUANTITY = 0) THEN 'CC'
 WHEN ((DEL.TRADETYPE = 'STCK' AND REC.TRADETYPE = 'STCK') AND DEL.OPENQUANTITY = 0 AND REC.OPENQUANTITY = 0) THEN 'SS'
 WHEN ((DEL.TRADETYPE = 'CASH' AND DEL.OPENQUANTITY = 0) OR (REC.TRADETYPE = 'CASH' AND REC.OPENQUANTITY = 0)) THEN 'C'
 WHEN ((DEL.TRADETYPE = 'STCK' AND DEL.OPENQUANTITY = 0) OR (REC.TRADETYPE = 'STCK' AND REC.OPENQUANTITY = 0)) THEN 'S'
 END) AS SETTLED_COMPONENTS,
(CASE
 WHEN (DEL.SETTLEMENTDATE IS NULL AND REC.SETTLEMENTDATE IS NOT NULL) OR (REC.SETTLEMENTDATE >= DEL.SETTLEMENTDATE) THEN REC.SETTLEMENTDATE
 WHEN (REC.SETTLEMENTDATE IS NULL AND DEL.SETTLEMENTDATE IS NOT NULL) OR (DEL.SETTLEMENTDATE >= REC.SETTLEMENTDATE) THEN DEL.SETTLEMENTDATE
 END) AS SETTLEMENTDATE
FROM STAGING.HIS_GLOSS_DAILY_TRADE M
LEFT OUTER JOIN 
(SELECT GLOSSTRADEREFERENCE, VERSION, TRADETYPE, OPENQUANTITY, SETTLEMENTDATE FROM STAGING.HIS_GLOSS_SETTLEMENT WHERE EFFECTIVEENDDATE IS NULL AND OPERATIONTYPE = 'DEL') DEL 
 ON M.GLOSSTRADEREFERENCE = DEL.GLOSSTRADEREFERENCE AND M.TRADEVERSION = DEL.VERSION
LEFT OUTER JOIN 
(SELECT GLOSSTRADEREFERENCE, VERSION, TRADETYPE, OPENQUANTITY, SETTLEMENTDATE FROM STAGING.HIS_GLOSS_SETTLEMENT WHERE EFFECTIVEENDDATE IS NULL AND OPERATIONTYPE = 'REC') REC 
 ON M.GLOSSTRADEREFERENCE = REC.GLOSSTRADEREFERENCE AND M.TRADEVERSION = DEL.VERSION
WHERE M.EFFECTIVEENDDATE IS NULL
ORDER BY M.GLOSSTRADEREFERENCE
