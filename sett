SELECT M.GLOSSTRADEREFERENCE, M.TRADETYPE, 
(CASE 
WHEN M.TRADETYPE IN ('PRIN','NET','CAGS','CSEC','BAGS') THEN 'CSSC'
WHEN M.TRADETYPE IN ('CCSH', 'FXMV','SNET') THEN 'C'
WHEN M.TRADETYPE IN ('NTRN') THEN 'CC'
WHEN M.TRADETYPE IN ('BLPM','DACS','CLBO','CLBR','DTRN','PNET','BLCM','BLOM','FRES','TKOS') THEN 'S'
 END) AS EXPECTED_COMPONENTS,
 DEL.TRADETYPE AS DEL_TRADETYPE, DEL.OPENQUANTITY AS DEL_OPENQUANTITY, REC.TRADETYPE AS REC_TRADETYPE, REC.OPENQUANTITY AS REC_OPENQUANTITY,
(CASE 
 WHEN ((DEL.TRADETYPE = 'CASH' AND REC.TRADETYPE = 'STCK') OR (DEL.TRADETYPE = 'STCK' AND REC.TRADETYPE = 'CASH') AND DEL.OPENQUANTITY = 0 AND REC.OPENQUANTITY = 0) THEN 'CSSC'
 WHEN ((DEL.TRADETYPE = 'CASH' AND REC.TRADETYPE = 'CASH') AND DEL.OPENQUANTITY = 0 AND REC.OPENQUANTITY = 0) THEN 'CC'
 WHEN ((DEL.TRADETYPE = 'STCK' AND REC.TRADETYPE = 'STCK') AND DEL.OPENQUANTITY = 0 AND REC.OPENQUANTITY = 0) THEN 'SS'
 WHEN ((DEL.TRADETYPE = 'CASH' AND DEL.OPENQUANTITY = 0) OR (REC.TRADETYPE = 'CASH' AND REC.OPENQUANTITY = 0)) THEN 'C'
 WHEN ((DEL.TRADETYPE = 'STCK' AND DEL.OPENQUANTITY = 0) OR (REC.TRADETYPE = 'STCK' AND REC.OPENQUANTITY = 0)) THEN 'S'
 END) AS SETTLED_COMPONENTS,
(CASE
 WHEN (DEL.SETTLEMENTDATE IS NULL AND REC.SETTLEMENTDATE IS NOT NULL) OR (REC.SETTLEMENTDATE >= DEL.SETTLEMENTDATE) THEN REC.SETTLEMENTDATE
 WHEN (REC.SETTLEMENTDATE IS NULL AND DEL.SETTLEMENTDATE IS NOT NULL) OR (DEL.SETTLEMENTDATE >= REC.SETTLEMENTDATE) THEN DEL.SETTLEMENTDATE
 END) AS SETTLEMENTDATE
FROM STAGING.HIS_GLOSS_DAILY_TRADE M
LEFT OUTER JOIN 
(SELECT GLOSSTRADEREFERENCE, VERSION, TRADETYPE, OPENQUANTITY, SETTLEMENTDATE FROM STAGING.HIS_GLOSS_SETTLEMENT WHERE EFFECTIVEENDDATE IS NULL AND OPERATIONTYPE = 'DEL') DEL 
 ON M.GLOSSTRADEREFERENCE = DEL.GLOSSTRADEREFERENCE AND M.TRADEVERSION = DEL.VERSION
LEFT OUTER JOIN 
(SELECT GLOSSTRADEREFERENCE, VERSION, TRADETYPE, OPENQUANTITY, SETTLEMENTDATE FROM STAGING.HIS_GLOSS_SETTLEMENT WHERE EFFECTIVEENDDATE IS NULL AND OPERATIONTYPE = 'REC') REC 
 ON M.GLOSSTRADEREFERENCE = REC.GLOSSTRADEREFERENCE AND M.TRADEVERSION = DEL.VERSION
WHERE M.EFFECTIVEENDDATE IS NULL
ORDER BY M.GLOSSTRADEREFERENCE



SELECT GDT.GLOSSTRADEREFERENCE,GDT.TRADEEXECUTIONNUMBER,GDT.TRADESTATUS,GDT.TRADEVERSION,GDT.SETTLEMENTAMOUNT,GDT.TRADETYPE,
GDT.MARKETREFERENCE,GDT.TRADEOPERATIONTYPE,GDT.COUNTERPARTYREFERENCE,GDT.VALUEDATE,
B.NAME, B.ACCDEPTCODE, B.CABOOKTYPE, 
GP.MIDPRICE,
(CASE
 WHEN S.EXPECTEDCOMPONENTS = S.SETTLEDCOMPONENTS THEN S.SETTLEMENTDATE
 END) AS SETTLEMENTDATE,
(CASE
 WHEN S.EXPECTEDCOMPONENTS = 'N/A' THEN 'N/A'
 WHEN S.EXPECTEDCOMPONENTS = S.SETTLEDCOMPONENTS THEN 'Y'
 WHEN ((S.EXPECTEDCOMPONENTS <> S.SETTLEDCOMPONENTS) AND (S.DEL_OPENQUANTITY = 0 OR S.REC_OPENQUANTITY = 0)) THEN 'P'
 ELSE 'N'
 END) AS SETTLEMENTINDICATOR
FROM STAGING.HIS_GLOSS_DAILY_TRADE GDT
LEFT OUTER JOIN STAGING.HIS_BOOK B ON GDT.BOOKREFERENCE = B.BOOKID
LEFT OUTER JOIN STAGING.HIS_GLOSS_PRICE GP ON GDT.INSTRUMENTID = GP.INSTRUMENTID
LEFT OUTER JOIN STAGING.INTERIM_SETTLEMENT S ON GDT.GLOSSTRADEREFERENCE = S.GLOSSTRADEREFERENCE
WHERE GDT.EFFECTIVEENDDATE IS NULL
AND B.EFFECTIVEENDDATE IS NULL
AND GP.EFFECTIVEENDDATE IS NULL
;
